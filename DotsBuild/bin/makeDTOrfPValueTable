#!@perl@
use strict;
use lib "$ENV{GUS_HOME}/lib/perl";
use Getopt::Long;
use GUS::ObjRelP::DbiDatabase;
use GUS::Common::GusConfig;
use CBIL::Bio::SequenceUtils;

my ($verbose,$musExtRelDbId,$humExtRelDbId,$gusConfigFile,$allgenesSchema);
&GetOptions("verbose!"=> \$verbose,
            "allgenesSchema=s"=> \$allgenesSchema,
            "gusConfigFile=s" => \$gusConfigFile);


die "usage: makeDTOfrPValueTable --allgenesSchema --verbose --gusConfigFile [\$GUS_CONFIG_FILE]\n"
unless ($allgenesSchema);

print STDERR "Establishing dbi login\n" if $verbose;

my $gusconfig = GUS::Common::GusConfig->new($gusConfigFile);

my $db = GUS::ObjRelP::DbiDatabase->new($gusconfig->getDbiDsn(),
					$gusconfig->getDatabaseLogin(),
					$gusconfig->getDatabasePassword(),
					$verbose,0,1,
					$gusconfig->getCoreSchemaName());

my $dbh = $db->getQueryHandle();

my $tableName = "${allgenesSchema}.DTOrfPValue";

print STDERR "Dropping table $tableName\n";
$dbh->do("drop table $tableName");

my $createTblSql = 
"CREATE TABLE $tableName
   (TAXON_ID NUMBER(12) NOT NULL,
    NA_SEQUENCE_ID NUMBER(12) NOT NULL,
    P_VALUE FLOAT(126))
    STORAGE (MAXEXTENTS UNLIMITED)";

print STDERR "CreateTblSql: $createTblSql\n" if $verbose;

print STDERR "Creating table  $tableName\n";
$dbh->do($createTblSql) || die "Failed creating table $tableName\n SQL: $createTblSql";

my $insertSql = 
"insert into $tableName 
    select a.taxon_id, a.na_sequence_id, taf.p_value
    from dots.Assembly a, dots.NAFeature naf, dots.TranslatedAAFeature taf
    where a.na_sequence_id = naf.na_sequence_id
    and naf.na_feature_id = taf.na_feature_id";

print STDERR "Inserting \n";
print STDERR "insertSql: $insertSql\n" if $verbose;

$dbh->do($insertSql) || die "Insert failed.\nSQL: $insertSql";

print STDERR "Committing\n";
$dbh->commit();

print STDERR "Indexing\n";
my $indexSql = "CREATE INDEX ${tableName}_IND01 on $tableName (NA_SEQUENCE_ID) TABLESPACE INDX";
$dbh->do($indexSql) || die "Indexing failed.\nSQL: $indexSql";

print STDERR "Analyzing\n";
my $analyzeSql = "ANALYZE TABLE $tableName compute statistics";
$dbh->do($analyzeSql) || die "Analyze failed.\nSQL: $analyzeSql";

print STDERR "Granting\n";
my $grantSql = "grant select on $tableName to public";
$dbh->do($grantSql) || die "Grant failed.\nSQL: $grantSql";


